<div  class="customDropdown" (click)="show(dialog)" #myButton>
  <span>{{name}}</span>
  <i class="fas fa-caret-down multi-select-ml-1"></i>
</div>

<ng-template #dialog>
  <mat-dialog-content>
    <div class="contentDiv" [style.maxHeight]="innerContentDivHeight + 'px'" (window:resize)="onResize($event)">
      <div class="set-box" *ngFor="let set of internalSelectionSets; index as setIndex">
        <div class="container-fluid" *ngIf="set.name || set.maxSelections < set.selectionSet.length">
          <div class="rowBox multi-select-mt-3 align-items-center">
            <div class="col setName" >{{set.name}}</div>
            <div class="col-5 subHeading" *ngIf="set.maxSelections < set.selectionSet.length">Select up to {{set.maxSelections}}</div>
          </div>
        </div>
        <!--This section is for non sortable listing. The look is different for this section with each row not being covered by a box etc and shorter selection items-->
        <div *ngIf="!set.sortable">
          <div *ngFor="let selection of set.selectionSet; index as i">
            <div class="non-sortable-box rowBox">
              <input class="multi-select-ml-2" type="checkbox" [disabled]="selection.disabled || (!selection.selected && set.currentSelectedCount === set.maxSelections)" [ngModel]="selection.selected" (ngModelChange)="onCheckedNonSortable(i, $event,setIndex)">
              <div class="multi-select-ml-2">{{selection.name}}</div>
            </div>
          </div>
        </div>
        <!--The next three divs are sortable listings. The look for all of them includes a box item-box class.-->
        <!--First section is for the items in the sortable list that are selected but disabled and not draggable.-->
        <!--Second section is for the draggble items. The items shown here have been sorted as per the setCurrentSelections function-->        
        <!--Third section is for those items that are not draggable and are not disabled.-->
        <!--Note items sent in with the settings of not selected, disabled and are not draggable are not show in any of the three sections.-->
        <div *ngIf="set.sortable">
          <div *ngFor="let selection of set.selectionSet; index as i">
            <div class="item-box" *ngIf="set.sortable && selection.disabled && selection.selected && !selection.draggable">
              <div class="rowBox">
                <i class="multi-select-ml-2 fas fa-grip-vertical hiddenIcon" ></i>
                <input class="multi-select-ml-3" type="checkbox" [disabled]="selection.disabled || (!selection.selected && set.currentSelectedCount === set.maxSelections)" [ngModel]="selection.selected" (ngModelChange)="onCheckedNonSortable(i, $event,setIndex)">
                <div class="multi-select-ml-2">{{selection.name}}</div>
              </div>
            </div>
          </div>
        </div>
        <!--hr *ngIf="set.sortable && set.sortableEndCount !== set.selectionSet.length"-->
        <div cdkDropList class="sortable-list" (cdkDropListDropped)="drop($event, setIndex)" *ngIf="set.sortable && set.sortableEndCount !== 0">
          <div *ngFor="let selection of set.selectionSet; index as i">
            <div class="item-box " [class.sortable-box]="selection.selected || set.currentSelectedCount < set.maxSelections" 
            *ngIf="selection.draggable" 
            cdkDrag [cdkDragDisabled]="(!selection.draggable || (!selection.selected  && set.currentSelectedCount >= set.maxSelections))">
              <div class="rowBox justify-between">
                <div class="rowBox">
                  <i class="multi-select-ml-2 fas fa-grip-vertical" [class.disabledIcon]="!selection.selected && set.currentSelectedCount >= set.maxSelections" ></i>
                  <input class="multi-select-ml-3" type="checkbox" [disabled]="selection.disabled || (!selection.selected && set.currentSelectedCount == set.maxSelections)" [ngModel]="selection.selected" (ngModelChange)="onChecked(i, $event, setIndex)">
                  <div class="multi-select-ml-2 selectionName">{{selection.name}}</div>
                </div>
                <div class="arrows multi-select-mr-1">
                  <!--The logic in this section is dependent on the sort order of the sortable set.-->
                  <a *ngIf="i  >  0 && ( selection.selected || set.currentSelectedCount <  set.maxSelections)" (click)="validateAndMove(set,i,i-1)"><i class="fas fa-arrow-up multi-select-mr-2"></i></a>
                  <a *ngIf="i === 0 || (!selection.selected && set.currentSelectedCount >= set.maxSelections)"><i class="fas fa-arrow-up disabledIcon multi-select-mr-2"></i></a>
                  <!--The logic below is to show the disabled arrow if it is the last of the sortable items or the item is not selected and max selections have been done or item is selected as well as the index is not equal to the max number of selections  excluding the disabled and selected items-->
                  <a *ngIf="(i === (set.sortableEndCount -1 ) || (!selection.selected && set.currentSelectedCount === set.maxSelections) || ( selection.selected && i === (set.maxSelections - set.selectedAndNotDraggabledCount - 1)))"><i class="fas fa-arrow-down disabledIcon"></i></a>
                  <!--The logic below is the opposite of when to show an enabled arrow-->
                  <a *ngIf="(i !== (set.sortableEndCount -1 ) && ( selection.selected || set.currentSelectedCount  <  set.maxSelections) && (!selection.selected || i  <  (set.maxSelections - set.selectedAndNotDraggabledCount - 1)))" (click)="validateAndMove(set,i,i+1)"><i class="fas fa-arrow-down"></i></a>
                </div>
              </div>              
              <ng-container 
                [ngTemplateOutlet]="subSelections" 
                [ngTemplateOutletContext]="{parentSelection: selection}">
              </ng-container>
            </div>
          </div>
        </div>
        <!--This section is a repeat of the code above for non sortable section so that we can put the disabled, unchecked items at the bottom of the set.-->
        <div *ngIf="set.sortable">
          <div *ngFor="let selection of set.selectionSet; index as i">
            <div class="item-box" *ngIf="(set.sortable && !selection.draggable && !selection.disabled)">
              <div class="rowBox">
                <i class="multi-select-ml-2 fas fa-grip-vertical hiddenIcon" ></i>
                <input class="multi-select-ml-3" type="checkbox" [disabled]="selection.disabled || (!selection.selected && set.currentSelectedCount == set.maxSelections)" [ngModel]="selection.selected" (ngModelChange)="onCheckedNonSortable(i, $event,setIndex)">
                <div class="multi-select-ml-2">{{selection.name}}</div>
              </div>
            </div>
          </div>
        </div>
        <hr *ngIf="setIndex !== internalSelectionSets.length - 1 && (setIndex < internalSelectionSets.length - 1 && !internalSelectionSets[setIndex+1].name)">
      </div> <!--Set End-->
    </div> <!-- Content Div End-->
  </mat-dialog-content>
  <div class="button_row_popup">
    <input type="submit" value="Apply"  title="Apply" class="btn" (click)="save()" [disabled]="disableSave">
    <input type="submit" value="Cancel" title="Cancel" class="btn neg" (click)="cancel()">
  </div>
</ng-template>

<!--This section is to be used only for the sub section-->
<ng-template #subSelections let-parentSelection='parentSelection'>
  <div *ngIf="parentSelection.selected && parentSelection.subSelections">
    <ng-container *ngFor="let selection of parentSelection.subSelections; index as i">
      <div class="sub-detail rowBox" [class.details-showing]="selection.showDetails" >
        <a *ngIf="selection.selectionDetails && !selection.showDetails && selection.selected" (click)="showHideSelectionDetails(selection)"><i class="ml-1 mr-1 fas fa-plus-circle" ></i></a>
        <a *ngIf="selection.selectionDetails &&  selection.showDetails && selection.selected" (click)="showHideSelectionDetails(selection)"><i class="ml-1 mr-1 fas fa-minus-circle"></i></a>
        <input class="multi-select-ml-1" type="checkbox" [disabled]="selection.disabled" [(ngModel)]="selection.selected" >
        <div class="multi-select-ml-2">{{selection.name}}</div>
      </div>
      <ng-container *ngIf="selection.selectionDetails && selection.showDetails && selection.selected">
        <ng-container *ngFor="let detail of selection.selectionDetails">
          <div class="selection-details">{{detail}}</div>
        </ng-container>
      </ng-container>
    </ng-container>
  </div>
</ng-template>